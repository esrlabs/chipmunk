---
language:
  - node_js
  - rust

node_js: 10
rust: 1.36

env:
  - USE_HARD_LINKS=false

jobs:
  include:
    - stage: "Build for mac"
      os: osx
      install:
        - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        - rustup install stable
        - npm install jake typescript --global
      script:
        - rake full_pipeline[mac]
      before_deploy:
        - export CHIPMUNK_VERSION=$(cat application/electron/package.json | sed -n 3p | cut -d '"' -f 4)
        - ls -la application/electron/dist/release/*
      deploy: &deploy_base
        provider: releases
        api_key: $GITHUB_TOKEN
        draft: true
        skip_cleanup: true
        file: application/electron/dist/release/chipmunk@${CHIPMUNK_VERSION}-darwin-portable.tgz
    - stage: "Build for linux"
      os: linux
      install:
        - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        - rustup install stable
        - npm install jake typescript --global
      script:
        - rake full_pipeline[linux]
      before_deploy:
        - export CHIPMUNK_VERSION=$(cat application/electron/package.json | sed -n 3p | cut -d '"' -f 4)
        - ls -la application/electron/dist/release/*
      deploy:
        <<: *deploy_base
        file: application/electron/dist/release/chipmunk@${CHIPMUNK_VERSION}-linux-portable.tgz
    - stage: "Build for windows"
      os: windows
      install:
        - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        - rustup install stable
        - npm install jake typescript --global
      script:
        - rake full_pipeline[win]
      before_deploy:
        - export CHIPMUNK_VERSION=$(cat application/electron/package.json | sed -n 3p | cut -d '"' -f 4)
        - ls -la application/electron/dist/release/*
      deploy:
        <<: *deploy_base
        file: application/electron/dist/release/chipmunk@${CHIPMUNK_VERSION}-win64-portable.tgz
        draft: false
